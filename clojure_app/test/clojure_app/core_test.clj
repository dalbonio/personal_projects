(ns clojure-app.core-test
  (:require [clojure.test :refer :all]
            [clojure-app.core :refer :all]
            [clojure.data.json :as json]
            [clj-http.client :as client]))


(def crypto-list2 (list '("BTC", 65000.00), '("ETH", 1650.00), '("CHZ", 0.9), '("DOGE", 0.04), '("ADA", 1.05), '("LTC", 190.00), '("VET", 0.07), '("DOT", 30.00), '("XRP", 0.35), '("XLM", 0.35)))
(def api-call "{\"status\":{\"timestamp\":\"2021-03-20T13:57:26.924Z\",\"error_code\":0,\"error_message\":null,\"elapsed\":43,\"credit_count\":1,\"notice\":null},\"data\":{\"ADA\":[{\"id\":2010,\"name\":\"Cardano\",\"symbol\":\"ADA\",\"slug\":\"cardano\",\"num_market_pairs\":260,\"date_added\":\"2017-10-01T00:00:00.000Z\",\"tags\":[{\"slug\":\"mineable\",\"name\":\"Mineable\",\"category\":\"OTHER\"},{\"slug\":\"dpos\",\"name\":\"DPoS\",\"category\":\"CONSENSUS_ALGORITHM\"},{\"slug\":\"pos\",\"name\":\"PoS\",\"category\":\"CONSENSUS_ALGORITHM\"},{\"slug\":\"platform\",\"name\":\"Platform\",\"category\":\"PROPERTY\"},{\"slug\":\"research\",\"name\":\"Research\",\"category\":\"PROPERTY\"},{\"slug\":\"smart-contracts\",\"name\":\"Smart Contracts\",\"category\":\"PROPERTY\"},{\"slug\":\"staking\",\"name\":\"Staking\",\"category\":\"PROPERTY\"},{\"slug\":\"binance-chain\",\"name\":\"Binance Chain\",\"category\":\"PLATFORM\"}],\"max_supply\":45000000000,\"circulating_supply\":31948309440.747814,\"total_supply\":45000000000,\"is_active\":1,\"platform\":null,\"cmc_rank\":4,\"is_fiat\":0,\"last_updated\":\"2021-03-20T13:56:11.000Z\",\"quote\":{\"USD\":{\"price\":1.26340378553531,\"volume_24h\":6029073428.771265,\"percent_change_1h\":-0.6386125,\"percent_change_24h\":-2.22035719,\"percent_change_7d\":9.67810037,\"percent_change_30d\":36.29499581,\"percent_change_60d\":238.54622654,\"percent_change_90d\":673.09775929,\"market_cap\":40363615088.89427,\"last_updated\":\"2021-03-20T13:56:11.000Z\"}}}],\"BTC\":[{\"id\":1,\"name\":\"Bitcoin\",\"symbol\":\"BTC\",\"slug\":\"bitcoin\",\"num_market_pairs\":9893,\"date_added\":\"2013-04-28T00:00:00.000Z\",\"tags\":[{\"slug\":\"mineable\",\"name\":\"Mineable\",\"category\":\"OTHER\"},{\"slug\":\"pow\",\"name\":\"PoW\",\"category\":\"CONSENSUS_ALGORITHM\"},{\"slug\":\"sha-256\",\"name\":\"SHA-256\",\"category\":\"CONSENSUS_ALGORITHM\"},{\"slug\":\"store-of-value\",\"name\":\"Store of Value\",\"category\":\"PROPERTY\"},{\"slug\":\"state-channels\",\"name\":\"State channels\",\"category\":\"PROPERTY\"},{\"slug\":\"coinbase-ventures-portfolio\",\"name\":\"Coinbase Ventures Portfolio\",\"category\":\"PROPERTY\"},{\"slug\":\"three-arrows-capital-portfolio\",\"name\":\"Three Arrows Capital Portfolio\",\"category\":\"PROPERTY\"},{\"slug\":\"polychain-capital-portfolio\",\"name\":\"Polychain Capital Portfolio\",\"category\":\"PROPERTY\"}],\"max_supply\":21000000,\"circulating_supply\":18659062,\"total_supply\":18659062,\"is_active\":1,\"platform\":null,\"cmc_rank\":1,\"is_fiat\":0,\"last_updated\":\"2021-03-20T13:57:02.000Z\",\"quote\":{\"USD\":{\"price\":59438.63658252702,\"volume_24h\":47470096787.75917,\"percent_change_1h\":0.0603094,\"percent_change_24h\":0.79703697,\"percent_change_7d\":-0.73529395,\"percent_change_30d\":15.51051145,\"percent_change_60d\":61.32568181,\"percent_change_90d\":153.29298641,\"market_cap\":1109069205188.8398,\"last_updated\":\"2021-03-20T13:57:02.000Z\"}}}],\"CHZ\":[{\"id\":4066,\"name\":\"Chiliz\",\"symbol\":\"CHZ\",\"slug\":\"chiliz\",\"num_market_pairs\":100,\"date_added\":\"2019-07-01T00:00:00.000Z\",\"tags\":[{\"slug\":\"sports\",\"name\":\"Sports\",\"category\":\"PROPERTY\"},{\"slug\":\"collectibles-nfts\",\"name\":\"Collectibles & NFTs\",\"category\":\"PROPERTY\"},{\"slug\":\"content-creation\",\"name\":\"Content Creation\",\"category\":\"PROPERTY\"},{\"slug\":\"payments\",\"name\":\"Payments\",\"category\":\"PROPERTY\"}],\"max_supply\":8888888888,\"circulating_supply\":5586362500.146096,\"total_supply\":8888888888,\"platform\":{\"id\":1027,\"name\":\"Ethereum\",\"symbol\":\"ETH\",\"slug\":\"ethereum\",\"token_address\":\"0x3506424f91fd33084466f402d5d97f05f8e3b4af\"},\"is_active\":1,\"cmc_rank\":36,\"is_fiat\":0,\"last_updated\":\"2021-03-20T13:56:10.000Z\",\"quote\":{\"USD\":{\"price\":0.59650899143413,\"volume_24h\":1800924618.3518398,\"percent_change_1h\":-1.51214516,\"percent_change_24h\":-12.17436481,\"percent_change_7d\":-24.82892101,\"percent_change_30d\":1494.82362461,\"percent_change_60d\":2771.81022398,\"percent_change_90d\":3692.40905369,\"market_cap\":3332315460.747593,\"last_updated\":\"2021-03-20T13:56:10.000Z\"}}}],\"DOGE\":[{\"id\":74,\"name\":\"Dogecoin\",\"symbol\":\"DOGE\",\"slug\":\"dogecoin\",\"num_market_pairs\":336,\"date_added\":\"2013-12-15T00:00:00.000Z\",\"tags\":[{\"slug\":\"mineable\",\"name\":\"Mineable\",\"category\":\"OTHER\"},{\"slug\":\"pow\",\"name\":\"PoW\",\"category\":\"CONSENSUS_ALGORITHM\"},{\"slug\":\"scrypt\",\"name\":\"Scrypt\",\"category\":\"CONSENSUS_ALGORITHM\"},{\"slug\":\"medium-of-exchange\",\"name\":\"Medium of Exchange\",\"category\":\"PROPERTY\"},{\"slug\":\"memes\",\"name\":\"Memes\",\"category\":\"PROPERTY\"},{\"slug\":\"payments\",\"name\":\"Payments\",\"category\":\"PROPERTY\"}],\"max_supply\":null,\"circulating_supply\":128838760774.69307,\"total_supply\":128838760774.69307,\"platform\":{\"id\":1839,\"name\":\"Binance Smart Chain\",\"symbol\":\"BNB\",\"slug\":\"binance-coin\",\"token_address\":\"0xba2ae424d960c26247dd6c32edc70b295c744c43\"},\"is_active\":1,\"cmc_rank\":17,\"is_fiat\":0,\"last_updated\":\"2021-03-20T13:57:03.000Z\",\"quote\":{\"USD\":{\"price\":0.05951105149708,\"volume_24h\":890783235.4331454,\"percent_change_1h\":0.34883533,\"percent_change_24h\":2.36730722,\"percent_change_7d\":5.26002454,\"percent_change_30d\":14.62392068,\"percent_change_60d\":540.1429259,\"percent_change_90d\":1297.93776078,\"market_cap\":7667330127.28273,\"last_updated\":\"2021-03-20T13:57:03.000Z\"}}}],\"DOT\":[{\"id\":6636,\"name\":\"Polkadot\",\"symbol\":\"DOT\",\"slug\":\"polkadot-new\",\"num_market_pairs\":170,\"date_added\":\"2020-08-19T00:00:00.000Z\",\"tags\":[{\"slug\":\"substrate\",\"name\":\"Substrate\",\"category\":\"PROPERTY\"},{\"slug\":\"polkadot\",\"name\":\"Polkadot\",\"category\":\"PLATFORM\"},{\"slug\":\"binance-chain\",\"name\":\"Binance Chain\",\"category\":\"PLATFORM\"},{\"slug\":\"polkadot-ecosystem\",\"name\":\"Polkadot Ecosystem\",\"category\":\"PROPERTY\"},{\"slug\":\"three-arrows-capital-portfolio\",\"name\":\"Three Arrows Capital Portfolio\",\"category\":\"PROPERTY\"},{\"slug\":\"polychain-capital-portfolio\",\"name\":\"Polychain Capital Portfolio\",\"category\":\"PROPERTY\"}],\"max_supply\":null,\"circulating_supply\":921920616.4259795,\"total_supply\":1057880283.7169263,\"platform\":{\"id\":2502,\"name\":\"Heco\",\"symbol\":\"HT\",\"slug\":\"huobi-token\",\"token_address\":\"0xa2c49cee16a5e5bdefde931107dc1fae9f7773e3\"},\"is_active\":1,\"cmc_rank\":6,\"is_fiat\":0,\"last_updated\":\"2021-03-20T13:57:06.000Z\",\"quote\":{\"USD\":{\"price\":39.31656936295389,\"volume_24h\":2360593166.843535,\"percent_change_1h\":-0.55213872,\"percent_change_24h\":5.39146303,\"percent_change_7d\":4.65365559,\"percent_change_30d\":25.88241313,\"percent_change_60d\":134.07549786,\"percent_change_90d\":649.32949774,\"market_cap\":36246755862.849236,\"last_updated\":\"2021-03-20T13:57:06.000Z\"}}}],\"ETH\":[{\"id\":1027,\"name\":\"Ethereum\",\"symbol\":\"ETH\",\"slug\":\"ethereum\",\"num_market_pairs\":6247,\"date_added\":\"2015-08-07T00:00:00.000Z\",\"tags\":[{\"slug\":\"mineable\",\"name\":\"Mineable\",\"category\":\"OTHER\"},{\"slug\":\"pow\",\"name\":\"PoW\",\"category\":\"CONSENSUS_ALGORITHM\"},{\"slug\":\"smart-contracts\",\"name\":\"Smart Contracts\",\"category\":\"PROPERTY\"},{\"slug\":\"ethereum\",\"name\":\"Ethereum\",\"category\":\"PLATFORM\"},{\"slug\":\"coinbase-ventures-portfolio\",\"name\":\"Coinbase Ventures Portfolio\",\"category\":\"PROPERTY\"},{\"slug\":\"three-arrows-capital-portfolio\",\"name\":\"Three Arrows Capital Portfolio\",\"category\":\"PROPERTY\"},{\"slug\":\"polychain-capital-portfolio\",\"name\":\"Polychain Capital Portfolio\",\"category\":\"PROPERTY\"}],\"max_supply\":null,\"circulating_supply\":115126058.124,\"total_supply\":115126058.124,\"platform\":{\"id\":2502,\"name\":\"Heco\",\"symbol\":\"HT\",\"slug\":\"huobi-token\",\"token_address\":\"0x64ff637fb478863b7468bc97d30a5bf3a428a1fd\"},\"is_active\":1,\"cmc_rank\":2,\"is_fiat\":0,\"last_updated\":\"2021-03-20T13:57:02.000Z\",\"quote\":{\"USD\":{\"price\":1851.019340368845,\"volume_24h\":21056103992.351536,\"percent_change_1h\":0.1409911,\"percent_change_24h\":1.9327381,\"percent_change_7d\":-1.71127966,\"percent_change_30d\":-2.64963056,\"percent_change_60d\":33.22184385,\"percent_change_90d\":185.62007186,\"market_cap\":213100560167.95178,\"last_updated\":\"2021-03-20T13:57:02.000Z\"}}}],\"LTC\":[{\"id\":2,\"name\":\"Litecoin\",\"symbol\":\"LTC\",\"slug\":\"litecoin\",\"num_market_pairs\":769,\"date_added\":\"2013-04-28T00:00:00.000Z\",\"tags\":[{\"slug\":\"mineable\",\"name\":\"Mineable\",\"category\":\"OTHER\"},{\"slug\":\"pow\",\"name\":\"PoW\",\"category\":\"CONSENSUS_ALGORITHM\"},{\"slug\":\"scrypt\",\"name\":\"Scrypt\",\"category\":\"CONSENSUS_ALGORITHM\"},{\"slug\":\"medium-of-exchange\",\"name\":\"Medium of Exchange\",\"category\":\"PROPERTY\"},{\"slug\":\"binance-chain\",\"name\":\"Binance Chain\",\"category\":\"PLATFORM\"}],\"max_supply\":84000000,\"circulating_supply\":66693002.01538747,\"total_supply\":66693002.01538747,\"platform\":{\"id\":2502,\"name\":\"Heco\",\"symbol\":\"HT\",\"slug\":\"huobi-token\",\"token_address\":\"0xecb56cf772b5c9a6907fb7d32387da2fcbfb63b4\"},\"is_active\":1,\"cmc_rank\":9,\"is_fiat\":0,\"last_updated\":\"2021-03-20T13:57:02.000Z\",\"quote\":{\"USD\":{\"price\":205.04191198512018,\"volume_24h\":2616685009.138123,\"percent_change_1h\":-0.33329567,\"percent_change_24h\":0.60994164,\"percent_change_7d\":-8.99421122,\"percent_change_30d\":-9.94003066,\"percent_change_60d\":28.80183803,\"percent_change_90d\":74.97427396,\"market_cap\":13674860649.26252,\"last_updated\":\"2021-03-20T13:57:02.000Z\"}}}],\"VET\":[{\"id\":3077,\"name\":\"VeChain\",\"symbol\":\"VET\",\"slug\":\"vechain\",\"num_market_pairs\":124,\"date_added\":\"2017-08-22T00:00:00.000Z\",\"tags\":[{\"slug\":\"logistics\",\"name\":\"Logistics\",\"category\":\"PROPERTY\"},{\"slug\":\"data-provenance\",\"name\":\"Data Provenance\",\"category\":\"PROPERTY\"},{\"slug\":\"smart-contracts\",\"name\":\"Smart Contracts\",\"category\":\"PROPERTY\"}],\"max_supply\":86712634466,\"circulating_supply\":64315576989,\"total_supply\":86712634466,\"is_active\":1,\"platform\":null,\"cmc_rank\":19,\"is_fiat\":0,\"last_updated\":\"2021-03-20T13:57:02.000Z\",\"quote\":{\"USD\":{\"price\":0.08666635243762,\"volume_24h\":840804834.9562837,\"percent_change_1h\":2.07396803,\"percent_change_24h\":3.98842866,\"percent_change_7d\":28.83421452,\"percent_change_30d\":59.15875862,\"percent_change_60d\":195.90383705,\"percent_change_90d\":414.68815536,\"market_cap\":5573996462.557557,\"last_updated\":\"2021-03-20T13:57:02.000Z\"}}}],\"XLM\":[{\"id\":512,\"name\":\"Stellar\",\"symbol\":\"XLM\",\"slug\":\"stellar\",\"num_market_pairs\":346,\"date_added\":\"2014-08-05T00:00:00.000Z\",\"tags\":[{\"slug\":\"medium-of-exchange\",\"name\":\"Medium of Exchange\",\"category\":\"PROPERTY\"},{\"slug\":\"enterprise-solutions\",\"name\":\"Enterprise solutions\",\"category\":\"PROPERTY\"},{\"slug\":\"decentralized-exchange\",\"name\":\"Decentralized exchange\",\"category\":\"PROPERTY\"},{\"slug\":\"smart-contracts\",\"name\":\"Smart Contracts\",\"category\":\"PROPERTY\"}],\"max_supply\":50001806812,\"circulating_supply\":22648880953.793217,\"total_supply\":50001803429.797806,\"is_active\":1,\"platform\":null,\"cmc_rank\":13,\"is_fiat\":0,\"last_updated\":\"2021-03-20T13:57:06.000Z\",\"quote\":{\"USD\":{\"price\":0.41371262498762,\"volume_24h\":987213286.8622907,\"percent_change_1h\":-0.88085166,\"percent_change_24h\":2.95487697,\"percent_change_7d\":2.30452926,\"percent_change_30d\":-16.24838574,\"percent_change_60d\":33.27671476,\"percent_change_90d\":131.80877028,\"market_cap\":9370127992.425903,\"last_updated\":\"2021-03-20T13:57:06.000Z\"}}}],\"XRP\":[{\"id\":52,\"name\":\"XRP\",\"symbol\":\"XRP\",\"slug\":\"xrp\",\"num_market_pairs\":681,\"date_added\":\"2013-08-04T00:00:00.000Z\",\"tags\":[{\"slug\":\"medium-of-exchange\",\"name\":\"Medium of Exchange\",\"category\":\"PROPERTY\"},{\"slug\":\"enterprise-solutions\",\"name\":\"Enterprise solutions\",\"category\":\"PROPERTY\"},{\"slug\":\"binance-chain\",\"name\":\"Binance Chain\",\"category\":\"PLATFORM\"}],\"max_supply\":100000000000,\"circulating_supply\":45404028640,\"total_supply\":99990831162,\"is_active\":1,\"platform\":null,\"cmc_rank\":7,\"is_fiat\":0,\"last_updated\":\"2021-03-20T13:57:03.000Z\",\"quote\":{\"USD\":{\"price\":0.49713999974878,\"volume_24h\":3614878829.615478,\"percent_change_1h\":0.32234782,\"percent_change_24h\":4.70527473,\"percent_change_7d\":9.58078521,\"percent_change_30d\":-6.7353022,\"percent_change_60d\":63.19307862,\"percent_change_90d\":-13.2143788,\"market_cap\":22572158786.6832,\"last_updated\":\"2021-03-20T13:57:03.000Z\"}}}]}}")

(deftest filter-json-crypto-test
  (testing "get price after api call"
    (is (float?  (get-in (first (get-in (json/read-str api-call) ["data", "ADA"])) ["quote", "USD", "price"])))))


(deftest json-to-map
  (testing "check if data is correctly mapped to "
    (let [data (get-crypto-data api-call)] 
      (println data)
      (is (= (count crypto-list2) (count data)))
      (is (= (count (filter #(= (count %) 3) data)) (count crypto-list2))))))

(deftest filter-crypto-data-test
  (testing "check if data is correctly filtered by current price < list price"
    (let [filtered-data (filter-crypto-data (get-crypto-data api-call))]
      (println filtered-data)
      (is (= (count filtered-data) 2)))))


(deftest send-email-test
  (testing "check if email is being sent"
    (send-crypto-email (clojure.string/join "\n" (filter-crypto-data (get-crypto-data api-call))))))


